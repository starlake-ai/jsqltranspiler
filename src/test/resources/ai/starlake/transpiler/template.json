{
  "schemas": [
    {
      "name": "audit",
      "tables": [
        {
          "name": "audit",
          "attrs": [
            [
              "count",
              "long",
              null
            ],
            [
              "countAccepted",
              "long",
              null
            ],
            [
              "countRejected",
              "long",
              null
            ],
            [
              "database",
              "string",
              null
            ],
            [
              "domain",
              "string",
              null
            ],
            [
              "duration",
              "long",
              null
            ],
            [
              "jobid",
              "string",
              null
            ],
            [
              "message",
              "string",
              null
            ],
            [
              "paths",
              "string",
              null
            ],
            [
              "scheduledDate",
              "timestamp",
              null
            ],
            [
              "schema",
              "string",
              null
            ],
            [
              "step",
              "string",
              null
            ],
            [
              "success",
              "boolean",
              null
            ],
            [
              "tenant",
              "string",
              null
            ],
            [
              "timestamp",
              "timestamp",
              null
            ]
          ]
        },
        {
          "name": "expectations",
          "attrs": [
            [
              "count",
              "long",
              null
            ],
            [
              "database",
              "string",
              null
            ],
            [
              "domain",
              "string",
              null
            ],
            [
              "exception",
              "string",
              null
            ],
            [
              "expect",
              "string",
              null
            ],
            [
              "jobid",
              "string",
              null
            ],
            [
              "query",
              "string",
              null
            ],
            [
              "schema",
              "string",
              null
            ],
            [
              "sql",
              "string",
              null
            ],
            [
              "success",
              "boolean",
              null
            ],
            [
              "timestamp",
              "timestamp",
              null
            ]
          ]
        },
        {
          "name": "rejected",
          "attrs": [
            [
              "domain",
              "string",
              null
            ],
            [
              "error",
              "string",
              null
            ],
            [
              "jobid",
              "string",
              null
            ],
            [
              "path",
              "string",
              null
            ],
            [
              "schema",
              "string",
              null
            ],
            [
              "timestamp",
              "timestamp",
              null
            ]
          ]
        }
      ]
    },
    {
      "name": "audit",
      "tables": [
        {
          "name": "audit",
          "attrs": [
            [
              "count",
              "long",
              null
            ],
            [
              "countAccepted",
              "long",
              null
            ],
            [
              "countRejected",
              "long",
              null
            ],
            [
              "database",
              "string",
              null
            ],
            [
              "domain",
              "string",
              null
            ],
            [
              "duration",
              "long",
              null
            ],
            [
              "jobid",
              "string",
              null
            ],
            [
              "message",
              "string",
              null
            ],
            [
              "paths",
              "string",
              null
            ],
            [
              "scheduledDate",
              "timestamp",
              null
            ],
            [
              "schema",
              "string",
              null
            ],
            [
              "step",
              "string",
              null
            ],
            [
              "success",
              "boolean",
              null
            ],
            [
              "tenant",
              "string",
              null
            ],
            [
              "timestamp",
              "timestamp",
              null
            ]
          ]
        },
        {
          "name": "expectations",
          "attrs": [
            [
              "count",
              "long",
              null
            ],
            [
              "database",
              "string",
              null
            ],
            [
              "domain",
              "string",
              null
            ],
            [
              "exception",
              "string",
              null
            ],
            [
              "expect",
              "string",
              null
            ],
            [
              "jobid",
              "string",
              null
            ],
            [
              "query",
              "string",
              null
            ],
            [
              "schema",
              "string",
              null
            ],
            [
              "sql",
              "string",
              null
            ],
            [
              "success",
              "boolean",
              null
            ],
            [
              "timestamp",
              "timestamp",
              null
            ]
          ]
        },
        {
          "name": "rejected",
          "attrs": [
            [
              "domain",
              "string",
              null
            ],
            [
              "error",
              "string",
              null
            ],
            [
              "jobid",
              "string",
              null
            ],
            [
              "path",
              "string",
              null
            ],
            [
              "schema",
              "string",
              null
            ],
            [
              "timestamp",
              "timestamp",
              null
            ]
          ]
        }
      ]
    },
    {
      "name": "audit",
      "tables": [
        {
          "name": "audit",
          "attrs": [
            [
              "count",
              "long",
              null
            ],
            [
              "countAccepted",
              "long",
              null
            ],
            [
              "countRejected",
              "long",
              null
            ],
            [
              "database",
              "string",
              null
            ],
            [
              "domain",
              "string",
              null
            ],
            [
              "duration",
              "long",
              null
            ],
            [
              "jobid",
              "string",
              null
            ],
            [
              "message",
              "string",
              null
            ],
            [
              "paths",
              "string",
              null
            ],
            [
              "scheduledDate",
              "timestamp",
              null
            ],
            [
              "schema",
              "string",
              null
            ],
            [
              "step",
              "string",
              null
            ],
            [
              "success",
              "boolean",
              null
            ],
            [
              "tenant",
              "string",
              null
            ],
            [
              "timestamp",
              "timestamp",
              null
            ]
          ]
        },
        {
          "name": "expectations",
          "attrs": [
            [
              "count",
              "long",
              null
            ],
            [
              "database",
              "string",
              null
            ],
            [
              "domain",
              "string",
              null
            ],
            [
              "exception",
              "string",
              null
            ],
            [
              "expect",
              "string",
              null
            ],
            [
              "jobid",
              "string",
              null
            ],
            [
              "query",
              "string",
              null
            ],
            [
              "schema",
              "string",
              null
            ],
            [
              "sql",
              "string",
              null
            ],
            [
              "success",
              "boolean",
              null
            ],
            [
              "timestamp",
              "timestamp",
              null
            ]
          ]
        },
        {
          "name": "rejected",
          "attrs": [
            [
              "domain",
              "string",
              null
            ],
            [
              "error",
              "string",
              null
            ],
            [
              "jobid",
              "string",
              null
            ],
            [
              "path",
              "string",
              null
            ],
            [
              "schema",
              "string",
              null
            ],
            [
              "timestamp",
              "timestamp",
              null
            ]
          ]
        }
      ]
    },
    {
      "name": "starbake",
      "tables": [
        {
          "name": "customers",
          "attrs": [
            [
              "email",
              "string",
              null
            ],
            [
              "first_name",
              "string",
              null
            ],
            [
              "id",
              "int",
              null
            ],
            [
              "join_date",
              "date",
              null
            ],
            [
              "last_name",
              "string",
              null
            ]
          ]
        },
        {
          "name": "orders",
          "attrs": [
            [
              "customer_id",
              "long",
              null
            ],
            [
              "order_date",
              "date",
              null
            ],
            [
              "order_id",
              "long",
              null
            ],
            [
              "product_id",
              "long",
              null
            ],
            [
              "quantity",
              "long",
              null
            ]
          ]
        },
        {
          "name": "products",
          "attrs": [
            [
              "category",
              "string",
              null
            ],
            [
              "cost",
              "double",
              null
            ],
            [
              "description",
              "string",
              null
            ],
            [
              "name",
              "string",
              null
            ],
            [
              "price",
              "double",
              null
            ],
            [
              "product_id",
              "int",
              null
            ]
          ]
        }
      ]
    },
    {
      "name": "starbake",
      "tables": [
        {
          "name": "customers",
          "attrs": [
            [
              "email",
              "string",
              null
            ],
            [
              "first_name",
              "string",
              null
            ],
            [
              "id",
              "int",
              null
            ],
            [
              "join_date",
              "date",
              null
            ],
            [
              "last_name",
              "string",
              null
            ]
          ]
        },
        {
          "name": "orders",
          "attrs": [
            [
              "customer_id",
              "long",
              null
            ],
            [
              "order_date",
              "date",
              null
            ],
            [
              "order_id",
              "long",
              null
            ],
            [
              "product_id",
              "long",
              null
            ],
            [
              "quantity",
              "long",
              null
            ]
          ]
        },
        {
          "name": "products",
          "attrs": [
            [
              "category",
              "string",
              null
            ],
            [
              "cost",
              "double",
              null
            ],
            [
              "description",
              "string",
              null
            ],
            [
              "name",
              "string",
              null
            ],
            [
              "price",
              "double",
              null
            ],
            [
              "product_id",
              "int",
              null
            ]
          ]
        }
      ]
    },
    {
      "name": "starbake",
      "tables": [
        {
          "name": "customers",
          "attrs": [
            [
              "email",
              "string",
              null
            ],
            [
              "first_name",
              "string",
              null
            ],
            [
              "id",
              "int",
              null
            ],
            [
              "join_date",
              "date",
              null
            ],
            [
              "last_name",
              "string",
              null
            ]
          ]
        },
        {
          "name": "orders",
          "attrs": [
            [
              "customer_id",
              "long",
              null
            ],
            [
              "order_date",
              "date",
              null
            ],
            [
              "order_id",
              "long",
              null
            ],
            [
              "product_id",
              "long",
              null
            ],
            [
              "quantity",
              "long",
              null
            ]
          ]
        },
        {
          "name": "products",
          "attrs": [
            [
              "category",
              "string",
              null
            ],
            [
              "cost",
              "double",
              null
            ],
            [
              "description",
              "string",
              null
            ],
            [
              "name",
              "string",
              null
            ],
            [
              "price",
              "double",
              null
            ],
            [
              "product_id",
              "int",
              null
            ]
          ]
        }
      ]
    },
    {
      "name": "starbake_analytics",
      "tables": [
        {
          "name": "customer_purchase_history",
          "attrs": [
            [
              "customer_id",
              "long",
              null
            ],
            [
              "customer_name",
              "string",
              null
            ],
            [
              "email",
              "string",
              null
            ],
            [
              "total_orders",
              "long",
              null
            ],
            [
              "total_spent",
              "double",
              null
            ],
            [
              "first_order_date",
              "date",
              null
            ],
            [
              "last_order_date",
              "date",
              null
            ],
            [
              "purchased_categories",
              "string",
              null
            ],
            [
              "days_since_first_order",
              "long",
              null
            ]
          ]
        },
        {
          "name": "order_items_analysis",
          "attrs": [
            [
              "order_id",
              "long",
              null
            ],
            [
              "order_date",
              "date",
              null
            ],
            [
              "customer_id",
              "long",
              null
            ],
            [
              "purchased_items",
              "string",
              null
            ],
            [
              "total_order_value",
              "double",
              null
            ]
          ]
        }
      ]
    },
    {
      "name": "starbake_analytics",
      "tables": [
        {
          "name": "customer_purchase_history",
          "attrs": [
            [
              "customer_id",
              "long",
              null
            ],
            [
              "customer_name",
              "string",
              null
            ],
            [
              "email",
              "string",
              null
            ],
            [
              "total_orders",
              "long",
              null
            ],
            [
              "total_spent",
              "double",
              null
            ],
            [
              "first_order_date",
              "date",
              null
            ],
            [
              "last_order_date",
              "date",
              null
            ],
            [
              "purchased_categories",
              "string",
              null
            ],
            [
              "days_since_first_order",
              "long",
              null
            ]
          ]
        },
        {
          "name": "order_items_analysis",
          "attrs": [
            [
              "order_id",
              "long",
              null
            ],
            [
              "order_date",
              "date",
              null
            ],
            [
              "customer_id",
              "long",
              null
            ],
            [
              "purchased_items",
              "string",
              null
            ],
            [
              "total_order_value",
              "double",
              null
            ]
          ]
        }
      ]
    },
    {
      "name": "starbake_kpis",
      "tables": [
        {
          "name": "overall_kpis",
          "attrs": [
            [
              "total_customers",
              "long",
              null
            ],
            [
              "total_orders",
              "long",
              null
            ],
            [
              "total_revenue",
              "double",
              null
            ],
            [
              "avg_order_value",
              "double",
              null
            ],
            [
              "avg_orders_per_customer",
              "double",
              null
            ],
            [
              "avg_spent_per_customer",
              "double",
              null
            ],
            [
              "earliest_order_date",
              "date",
              null
            ],
            [
              "latest_order_date",
              "date",
              null
            ],
            [
              "avg_customer_lifetime_days",
              "double",
              null
            ],
            [
              "avg_categories_per_customer",
              "double",
              null
            ],
            [
              "customer_order_rate",
              "double",
              null
            ],
            [
              "daily_revenue",
              "double",
              null
            ],
            [
              "daily_order_rate",
              "double",
              null
            ]
          ]
        }
      ]
    }
  ],
  "statements": [
    "\n----------------------------------------\n-- SQL when table does not already exist\n----------------------------------------\nCREATE TABLE starbake_analytics.customer_purchase_history AS WITH customer_orders AS (\n\nSELECT\no.customer_id,\nCOUNT(DISTINCT o.order_id) AS total_orders,\nSUM(o.quantity * p.price) AS total_spent,\nMIN(o.order_date) AS first_order_date,\nMAX(o.order_date) AS last_order_date,\nARRAY_AGG(DISTINCT p.category) AS purchased_categories\nFROM\nstarbake.orders o\nJOIN\nstarbake.products p ON o.product_id = p.product_id\nGROUP BY\no.customer_id\n)\nSELECT\nco.customer_id,\nconcat(c.first_name,' ', c.last_name) AS customer_name,\nc.email,\nco.total_orders,\nco.total_spent,\nco.first_order_date,\nco.last_order_date,\nco.purchased_categories,\n(CAST(co.last_order_date as DATE) - CAST(co.first_order_date as DATE)) as days_since_first_order\nFROM\nstarbake.customers c\nLEFT JOIN\ncustomer_orders co ON c.id = co.customer_id\nORDER BY\nco.total_spent DESC NULLS LAST;;\n",
    "\n---------------------------------\n-- SQL when table already exists\n---------------------------------\nINSERT INTO starbake_analytics.customer_purchase_history(\"customer_id\",\"customer_name\",\"email\",\"total_orders\",\"total_spent\",\"first_order_date\",\"last_order_date\",\"purchased_categories\",\"days_since_first_order\") WITH customer_orders AS (\n\nSELECT\no.customer_id,\nCOUNT(DISTINCT o.order_id) AS total_orders,\nSUM(o.quantity * p.price) AS total_spent,\nMIN(o.order_date) AS first_order_date,\nMAX(o.order_date) AS last_order_date,\nARRAY_AGG(DISTINCT p.category) AS purchased_categories\nFROM\nstarbake.orders o\nJOIN\nstarbake.products p ON o.product_id = p.product_id\nGROUP BY\no.customer_id\n)\nSELECT\nco.customer_id,\nconcat(c.first_name,' ', c.last_name) AS customer_name,\nc.email,\nco.total_orders,\nco.total_spent,\nco.first_order_date,\nco.last_order_date,\nco.purchased_categories,\n(CAST(co.last_order_date as DATE) - CAST(co.first_order_date as DATE)) as days_since_first_order\nFROM\nstarbake.customers c\nLEFT JOIN\ncustomer_orders co ON c.id = co.customer_id\nORDER BY\nco.total_spent DESC NULLS LAST;\n"
  ]
}